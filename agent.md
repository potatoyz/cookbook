# agent.md

## 开发规范 （Development Guidelines）

### 1. 项目概述

本项目面向家庭内部使用，提供点餐和厨房调度功能，需适配微信小程序。强调实时性、简单易用、可维护性和安全性。

### 2. 代码风格

* 使用 TypeScript 优先，必要时可以用 JavaScript。
* 使用 ESLint 规则（推荐基于 Airbnb 或社区通用规范）加上自定义项目规则。必须配置 Prettier 统一格式化。格式化在提交前自动完成（Git hooks）。
* 命名规范：

  * 变量与函数：camelCase
  * 组件/类：PascalCase
  * 文件名：kebab-case（页面/路由以简洁一词为准）
  * 常量：UPPER\_SNAKE\_CASE

### 3. Git 与分支策略

* 主分支（main 或 trunk）必须受保护，不能直接推送。
* 特性分支：`feature/描述`，修复分支：`fix/描述`，发布/热修复：`hotfix/描述`。
* 使用 Conventional Commits 风格提交信息，例如：

  * `feat: 添加点餐界面`
  * `fix: 修复订单状态更新错误`
  * `chore: 更新依赖`
* 每次合并前必须通过 CI 校验（lint + 测试）。

### 4. 代码审查（Pull Request）

* PR 必须包括清晰描述、相关 issue（如果有）、变更动机。
* 自审后再提交，避免大体积变更。
* 需要至少一名其他开发者审批。
* PR Checklist 例子：

  * 代码风格符合规范
  * 已添加/更新相应测试
  * 没有硬编码敏感信息
  * 新增功能有文档说明
  * 变更不会破坏现有功能（回归考虑）

### 5. 目录与模块组织

保持清晰分层，避免业务逻辑散落。每个模块只负责单一职责。避免深层嵌套。

### 6. API 设计

* 遵循 RESTful 原则（可考虑 versioning，如 `/api/v1/orders`）。
* 请求与响应统一格式（例如：

  ````json
  {"success": true, "data": ..., "error": null}
  ``` )
  ````
* 错误使用统一 error code，带明确 human-readable message。
* 所有输入必须验证与清洗（后端和必要前端双重验证）。
* 分页、排序、过滤标准化接口参数。

### 7. 数据模型（核心实体）

* User（家庭成员 / 厨师 / 管理员）
* MenuItem（菜品，含所需食材、准备时间）
* Order（包含用户、菜品、状态、备注、时间戳）
* Ingredient（食材库存、单位、保质期）
* Notification（订单通知记录、状态）
* Inventory / PreparationSuggestion（用于提前准备）

### 8. 通知机制

* 新订单需即时通知厨师：优先用 WebSocket 持久连接，小程序端可使用订阅消息作为补偿机制。
* 通知需具备重试、去重、阅读状态跟踪。
* 失败时记录日志，并支持人工重发。

### 9. 安全

* 登录：使用微信小程序登录态换取服务器 session / JWT。
* 鉴权：基于角色（member/chef/admin）的权限控制。
* 所有外部输入做严格校验与防注入（SQL/模板/XSS）。
* 使用 HTTPS，敏感配置（如密钥）不入版本库，使用环境变量或安全存储。
* 日志不要记录明文敏感数据。
* 设置接口限流，防止滥用。

### 10. 测试

* 单元测试覆盖核心逻辑（Order 流程、通知调度、验证）。
* 集成测试验证端到端数据流。
* 可选端到端测试（如用 Playwright / Cypress 在 Web 版本模拟点餐与厨师确认）。
* CI 保证测试通过后才能合并。

### 11. 本地开发与环境配置

* 使用 `.env.example` 提供示例环境变量。
* 区分 dev / staging / prod 配置。
* 本地安全模拟微信登录（使用 mock 或沙箱）。

### 12. CI/CD

* 每次推送运行 lint、测试、构建。
* 合并后部署到 staging，手动确认后发布到生产。
* 使用版本标签（如 v1.0.0）管理发布。

### 13. 错误处理与日志

* 全局统一错误处理器，内部错误返回安全通用信息给前端，详细日志写入后台。
* 日志按级别分类（ERROR/WARN/INFO/DEBUG），支持集中查看（如通过日志聚合服务）。

### 14. 国际化

* 初始仅简体中文，全部文案可抽取到资源文件以备将来扩展。

### 15. 性能优化

* 前端避免一次性拉取全部数据，使用分页 / 懒加载。
* 后端必要时缓存热点数据。
* 对频繁交互（如点餐）做防抖节流处理。

### 16. 可访问性

* 页面基础支持（如清晰按钮、足够触控区域、文字可读）。

### 17. 依赖管理

* 锁定版本（lockfile），定期更新依赖并审查变更（建议自动化如 Dependabot）。
* 新增第三方包前先评估安全与体积影响。

### 18. 版本控制与发布说明

* 发布时更新 CHANGELOG（遵循 Keep a Changelog）。
* 重大变更需提前在文档注明。

### 19. 回滚与备份

* 重要数据定期备份（如果不是轻量本地存储）。
* 发布失败支持快速回滚到上一个稳定版本。

### 20. 监控报警

* 关键流程出错需报警（如订单失败、通知失败率升高）。
* 错误率 / 延迟 / 可用性采集指标。

### 21. 隐私与数据保留

* 只保存必要的用户信息。
* 明确数据保留周期（例如订单保留 30 天后清理，除非用户另有要求）。

### 22. 文档与注释

* 公共接口有文档注释（OpenAPI / Swagger 或简单 Markdown API 说明）。
* 复杂逻辑前添加简要注释，避免过度冗余。

### 23. UI 设计建议（简要）

* 保持界面简洁，操作一步直达。
* 状态显著（订单状态、准备进度）。
* 异常反馈友好明确。

### 24. 其他

* 遵循 YAGNI 与 KISS 原则：先做刚需，避免过早复杂化。
* 每次大改前写短 RFC 说明动机与方案。
